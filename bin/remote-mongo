#!/usr/bin/env ruby

def info msg
  STDERR.puts "=> #{msg}"
end

def read_config app
  info "Reading config from Heroku app #{app}"
  IO.popen "heroku config -s --app #{app}", "r" do |io|
    io.each_line do |line|
      if m = line.scan(%r{^(MONGO.*?)=(mongodb://.+)$}).first
        info "Found #{m.first}"
        return m[1]
      end
    end
    info "No MongoDB URL found."
    exit 1
  end
end

if ARGV.empty?
  STDERR.puts "Specify a MongoDB URL or a Heroku app as the sole argument."
  exit 1
end

arg = ARGV[0]
arg = read_config arg unless arg.include? ?/

require 'uri'
uri = URI.parse arg

opts = []
opts << ["-u", uri.user] if uri.user
opts << ["-p", uri.password] if uri.password

hp = uri.host
hp += ":#{uri.port}" if uri.port

exec "mongo #{opts.join(' ')} #{hp}#{uri.path}"
