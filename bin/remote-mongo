#!/usr/bin/env ruby
# vim: filetype=ruby

def info msg
  STDERR.puts "=> #{msg}"
end

def read_config app
  info "Reading config from Heroku app #{app}"
  IO.popen "heroku config -s --app #{app}", "r" do |io|
    io.each_line do |line|
      if m = line.scan(%r{^(MONGO.*?)='{0,1}(mongodb(\+[a-z]+){0,1}://.+?)'{0,1}$}).first
        info "Found #{m.first}"
        return m[1].sub(%r{,[^/]+/}, '/')
      end
    end
    info "No MongoDB URL found."
    exit 1
  end
end

if ARGV.empty?
  STDERR.puts "Specify a Heroku app name as the sole argument."
  exit 1
end

exec "mongo #{read_config(ARGV[0])}"
